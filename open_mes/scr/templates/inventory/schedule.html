{% extends "inventory/base.html" %}
{% load md5url %}
{% block inventory_content %}
{{ auto_refresh|safe }}

<div id="schedule-container">
    <h2>入庫予定一覧</h2>
    <p id="schedule-count-info"></p> <!-- 取得件数を表示するための要素を追加 -->
    <table id="schedule-table" class="inventory-table">
        <thead>
            <tr>
                <th>発注番号</th>
                <th>仕入れ先</th>
                <th>品名</th>
                <th>発注数量</th>
                <th>入庫済数量</th>
                <th>発注日</th>
                <th>到着予定日</th>
                <th>倉庫</th>
                <th>ステータス</th>
            </tr>
        </thead>
        <tbody>
            <!-- AJAX 取得データ -->
        </tbody>
    </table>
    <div id="pagination-controls" class="pagination">
        
    </div>
</div>

<!-- Note: The common table styles are assumed to be moved to a shared CSS file or base.html using the .inventory-table class -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(function() {
        let currentPage = 1;
        const pageSize = 100; // 1ページあたりの表示件数

        function loadScheduleData(page) {
            currentPage = page;
            $.ajax({
                url: `/api/inventory/schedules/data/?page=${page}&page_size=${pageSize}`, // ページとページサイズを指定
            }).done(function(data) {
                    $('#schedule-table tbody').empty(); // テーブルの既存データをクリア
                    $('#schedule-count-info').empty(); // 件数表示エリアをクリア


                    const actualData = data.results || []; // APIからのデータは data.results に格納される
                    const totalCount = data.count || 0;
                    const displayCount = actualData.length;
                    const startItem = totalCount > 0 ? (currentPage - 1) * pageSize + 1 : 0;
                    const endItem = totalCount > 0 ? Math.min(startItem + pageSize - 1, totalCount) : 0;

                    // 取得件数を表示
                    if (totalCount > 0) {
                        $('#schedule-count-info').text(`全 ${totalCount} 件中 ${startItem} - ${endItem} 件を表示 (ページ ${currentPage} / ${data.num_pages || 1})`);
                    } else {
                        $('#schedule-count-info').text('該当するデータはありません。');
                    }

                    if (actualData && actualData.length > 0) {
                        $.each(actualData, function(index, item) { // 各データアイテムに対して処理
                            const newRow = $('<tr></tr>'); // 新しい行要素を作成

                            // 表示するデータの配列 (表示順)
                            const cellData = [
                                item.order_number,
                                item.supplier,
                                item.item,
                                item.quantity,
                                item.received_quantity,
                                item.order_date,
                                item.expected_arrival,
                                item.warehouse,
                                item.status
                            ];

                            cellData.forEach(function(value) {
                                // null や undefined の場合は空文字を表示
                                const cellText = (value === null || value === undefined) ? '' : value;
                                newRow.append($('<td></td>').text(cellText)); // セルを作成して行に追加
                            });
                            $('#schedule-table tbody').append(newRow); // 完成した行をテーブル本体に追加
                        });
                    }

                    renderPaginationControls(data.num_pages, data.current_page, data.previous, data.next);
            }).fail(function() {
                    $('#schedule-count-info').empty().text('データの読み込みに失敗しました。'); // エラー時も件数表示エリアを更新
            });
        }

        function renderPaginationControls(totalPages, currentPage, prevPage, nextPage) {
            const $p = $('#pagination-controls').empty();
            if (totalPages <= 1) return;

            // 「前へ」ボタン
            if (prevPage) {
                $('<button class="page-btn prev-btn">&laquo; 前へ</button>')
                    .on('click', () => loadScheduleData(prevPage))
                    .appendTo($p);
            }

            // 現在ページの前後 ±3 を表示
            const start = Math.max(1, currentPage - 3);
            const end   = Math.min(totalPages, currentPage + 3);
            for (let i = start; i <= end; i++) {
                $('<button class="page-btn">')
                    .text(i)
                    .toggleClass('active', i === currentPage)
                    .prop('disabled', i === currentPage)
                    .on('click', () => loadScheduleData(i))
                    .appendTo($p);
            }

            // 「次へ」ボタン
            if (nextPage) {
                $('<button class="page-btn next-btn">次へ &raquo;</button>')
                    .on('click', () => loadScheduleData(nextPage))
                    .appendTo($p);
            }

            // ダイレクトジャンプ用入力＆ボタン
            const $input = $(`<input type="number" min="1" max="${totalPages}" value="${currentPage}" class="page-input">`);
            const $go    = $('<button class="page-go-btn">移動</button>');
            $go.on('click', () => {
                const page = parseInt($input.val(), 10);
                if (page >= 1 && page <= totalPages && page !== currentPage) {
                    loadScheduleData(page);
                }
            });
            // Enterキーでも移動
            $input.on('keypress', e => {
                if (e.which === 13) $go.click();
            });

            $p.append($('<span class="jump-label">ページ: </span>'), $input, $go);
        }

        loadScheduleData(currentPage); // ページ読み込み時に最初のページデータを取得
    });
</script>
<style>
.pagination { margin-top: 20px; text-align: center; }
.page-btn {
  margin: 0 5px;
  padding: 5px 10px;
  border: 1px solid #ddd;
  background: #f8f8f8;
  cursor: pointer;
}
.page-btn.active,
.page-btn:disabled {
  background: #007bff;
  color: #fff;
  border-color: #007bff;
  cursor: default;
}
.page-input {
  width: 50px;
  text-align: center;
  margin: 0 5px;
}
.page-go-btn {
  padding: 5px 10px;
  border: 1px solid #ddd;
  background: #e0e0e0;
  cursor: pointer;
}
.jump-label {
  margin-left: 15px;
}
</style>

{% endblock inventory_content %}
