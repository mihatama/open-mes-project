{% extends "inventory/base.html" %}
{% load md5url %}
{% block inventory_content %}
{{ auto_refresh|safe }}

<div id="purchase-container">
    {% csrf_token %} {# Add CSRF token for AJAX POST requests #}
    <h2>入庫処理一覧</h2>
    <div id="scan-area">
        <label for="barcode-input">バーコード/シリアル番号:</label>
        <input type="text" id="barcode-input" name="barcode-input">
        <button id="scan-button">検索</button>
    </div>
    <table id="purchase-table" class="inventory-table">
        <thead>
            <tr>
                <th>発注番号</th>
                <th>仕入れ先</th>
                <th>品名</th>
                <th>発注数量</th>
                <th>入庫済数量</th>
                <th>発注日</th>
                <th>到着予定日</th>
                <th>倉庫</th>
                <th>ステータス</th>
                <th>バーコード</th>
                <th>シリアル番号</th>
                <th>処理</th>
            </tr>
        </thead>
        <tbody>
            <!-- ここにAJAXで取得したデータが挿入されます -->
        </tbody>
    </table>
</div>

<style>
    /* Note: Common table styles for .inventory-table are assumed to be moved to a shared CSS file or base.html */
    #scan-area {
        margin-bottom: 20px;
    }
    .receive-button {
        background-color: #4CAF50; /* Green */
        border: none;
        color: white;
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        margin: 2px;
        cursor: pointer;
        border-radius: 5px;
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        let allPurchaseItems = []; // 全ての入庫データを保持する配列
        let currentSearchTerm = ''; // 現在の検索語を保持

        // テーブルを描画する関数
        function renderTable(itemsToDisplay) {
            $('#purchase-table tbody').empty(); // テーブルの既存データをクリア
            if (itemsToDisplay && itemsToDisplay.length > 0) {
                $.each(itemsToDisplay, function(index, item) {
                    var row = $('<tr>');
                    row.append($('<td>').text(item.order_number));
                    row.append($('<td>').text(item.supplier));
                    row.append($('<td>').text(item.item));
                    row.append($('<td>').text(item.quantity));
                    row.append($('<td>').text(item.received_quantity));
                    row.append($('<td>').text(item.order_date));
                    row.append($('<td>').text(item.expected_arrival));
                    row.append($('<td>').text(item.warehouse));
                    row.append($('<td>').text(item.status));
                    row.append($('<td>').text(item.barcode));
                    row.append($('<td>').text(item.serial_number));

                    var receiveButton = $('<button>').addClass('receive-button').text('入庫処理').click(function() {
                        handleReceive(item.order_number);
                    });
                    var buttonCell = $('<td>').append(receiveButton);
                    row.append(buttonCell);

                    $('#purchase-table tbody').append(row);
                });
            } else {
                var message = '該当するデータが見つかりませんでした。';
                if (currentSearchTerm) {
                    message = '「' + currentSearchTerm + '」に一致するデータは見つかりませんでした。';
                }
                var noDataMsg = $('<tr><td colspan="12" style="text-align:center;">' + message + '</td></tr>');
                $('#purchase-table tbody').append(noDataMsg);
            }
        }

        // サーバーからデータをロードするか、プールされたデータでフィルタリングして表示する関数
        function loadPurchaseData(forceReload = false) {
            var dataUrl = '/inventory/purchase/data/';
            // forceReloadがtrue、またはデータプールが空の場合のみサーバーからデータを取得
            if (forceReload || allPurchaseItems.length === 0) {
                console.log('Loading data from server URL:', dataUrl);
                $.ajax({
                    url: dataUrl, // 検索パラメータなしで全件取得
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log('Data received from server:', data);
                        allPurchaseItems = data || []; // データプールを更新
                        filterAndRenderData(); // フィルタリングして表示
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading purchase data. URL:', dataUrl, 'Status:', status, 'Error:', error, 'Response:', xhr.responseText);
                        var errorDetail = xhr.responseText || 'サーバーからの応答がありません。ネットワーク接続を確認してください。';
                        var userErrorMsg = '入庫処理データの読み込みに失敗しました。';
                        var errorRow = $('<tr id="load-error-row"><td colspan="12" style="text-align:center; color:red;">' + userErrorMsg + '<br><small>詳細: ' + errorDetail + '</small></td></tr>');
                        $('#purchase-table tbody').empty().append(errorRow);
                        allPurchaseItems = []; // エラー時はプールを空にする
                        renderTable([]); // 空のテーブルを表示
                    }
                });
            } else {
                // 既にデータがある場合は、現在の検索語でフィルタリングして再描画
                console.log('Using cached data for rendering.');
                filterAndRenderData();
            }
        }

        // プールされたデータをフィルタリングして描画する関数
        function filterAndRenderData() {
            let itemsToDisplay = allPurchaseItems;
            if (currentSearchTerm) {
                const searchTermLower = currentSearchTerm.toLowerCase();
                itemsToDisplay = allPurchaseItems.filter(function(item) {
                    const orderNumber = item.order_number ? item.order_number.toLowerCase() : '';
                    const barcode = item.barcode ? item.barcode.toLowerCase() : '';
                    const serialNumber = item.serial_number ? item.serial_number.toLowerCase() : '';
                    return orderNumber.includes(searchTermLower) || barcode.includes(searchTermLower) || serialNumber.includes(searchTermLower);
                });
            }
            renderTable(itemsToDisplay);
        }

        function handleReceive(orderNumber) { // 引数名を orderId から orderNumber に変更
            // orderNumber が null, undefined, または空文字列でないことを確認
            if (!orderNumber) { // orderNumber が falsy (空文字列, null, undefinedなど) の場合
                alert('処理対象の発注番号が不明なため、入庫処理を実行できません。'); // メッセージを「発注番号」に修正
                console.error('handleReceive error: orderNumber is missing or invalid. Provided orderNumber:', orderNumber);
                return;
            }

            var receivedQtyStr = prompt("入庫する数量を入力してください:", "");
            if (receivedQtyStr === null) { // キャンセルされた場合
                return;
            }

            var receivedQty = parseInt(receivedQtyStr);
            if (isNaN(receivedQty) || receivedQty <= 0) {
                alert("有効な数量を入力してください。");
                return;
            }

            $.ajax({
                url: '/inventory/purchase/scan/', // 修正: 正しいAPIエンドポイント
                type: 'POST',
                dataType: 'json',
                data: {
                    order_number: orderNumber, // purchase_order_id の代わりに order_number を使用
                    received_quantity: receivedQty, // 追加: 入庫数量
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function(data) {
                    // HTTP 200 OK は成功とみなす
                    alert('入庫処理が完了しました。発注番号: ' + data.order_number + ', 新しい入庫済数量: ' + data.received_quantity);
                    loadPurchaseData(true); // サーバーからデータを強制的に再読み込みしてプールを更新
                },
                error: function(xhr, status, error) {
                    console.error('Error handling receive:', status, error, xhr.responseText);
                    var errorMsg = '入庫処理に失敗しました。';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg += '\n理由: ' + xhr.responseJSON.error;
                    }
                    alert(errorMsg);
                }
            });
        }

        // 「検索」ボタンがクリックされたときの処理 (クライアントサイドフィルタリング)
        function handleScan() {
            currentSearchTerm = $('#barcode-input').val().trim();
            console.log('Search term entered:', currentSearchTerm);
            filterAndRenderData(); // プールされたデータからフィルタリングして表示
        }

        // ページ読み込み時に初期データを取得（検索語なしで全件取得）
        loadPurchaseData(); 

        // スキャンボタンのクリックイベントハンドラを設定
        $('#scan-button').click(handleScan);

        // バーコード/シリアル番号入力フィールドでEnterキーを押したときにも検索を実行
        $('#barcode-input').keypress(function(event) {
            if (event.which == 13) { // 13 is the keycode for Enter
                event.preventDefault(); // Prevent default form submission
                handleScan();
            }
        });
    });
</script>

{% endblock inventory_content %}
