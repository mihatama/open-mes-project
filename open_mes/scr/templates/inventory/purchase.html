{% extends "inventory/base.html" %}
{% load md5url %}
{% block inventory_content %}
{{ auto_refresh|safe }}

<div id="purchase-container">
    {% csrf_token %} {# Add CSRF token for AJAX POST requests #}
    <h2>入庫処理一覧</h2>
    <div id="scan-area">
        <label for="barcode-input">バーコード/シリアル番号:</label>
        <input type="text" id="barcode-input" name="barcode-input">
        <button id="scan-button">入庫データ読込</button>
    </div>
    <table id="purchase-table" class="inventory-table">
        <thead>
            <tr>
                <th>発注番号</th>
                <th>仕入れ先</th>
                <th>品名</th>
                <th>発注数量</th>
                <th>入庫済数量</th>
                <th>発注日</th>
                <th>到着予定日</th>
                <th>倉庫</th>
                <th>ステータス</th>
                <th>バーコード</th>
                <th>シリアル番号</th>
                <th>処理</th>
            </tr>
        </thead>
        <tbody>
            <!-- ここにAJAXで取得したデータが挿入されます -->
        </tbody>
    </table>
</div>

<style>
    /* Note: Common table styles for .inventory-table are assumed to be moved to a shared CSS file or base.html */
    #scan-area {
        margin-bottom: 20px;
    }
    .receive-button {
        background-color: #4CAF50; /* Green */
        border: none;
        color: white;
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        margin: 2px;
        cursor: pointer;
        border-radius: 5px;
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        function loadPurchaseData() {
            $.ajax({
                url: '/inventory/purchase/data/', // 入庫処理データを取得するURL
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    $('#purchase-table tbody').empty(); // テーブルの既存データをクリア
                    $.each(data, function(index, item) {
                        var row = $('<tr>');
                        row.append($('<td>').text(item.order_number));
                        row.append($('<td>').text(item.supplier));
                        row.append($('<td>').text(item.item));
                        row.append($('<td>').text(item.quantity));
                        row.append($('<td>').text(item.received_quantity));
                        row.append($('<td>').text(item.order_date));
                        row.append($('<td>').text(item.expected_arrival));
                        row.append($('<td>').text(item.warehouse));
                        row.append($('<td>').text(item.status));
                        row.append($('<td>').text(item.barcode));
                        row.append($('<td>').text(item.serial_number));

                        // 入庫処理ボタンの追加
                        var receiveButton = $('<button>').addClass('receive-button').text('入庫処理').click(function() {
                            handleReceive(item.order_number); // 発注IDの代わりに発注番号を渡す
                        });
                        var buttonCell = $('<td>').append(receiveButton);
                        row.append(buttonCell);

                        $('#purchase-table tbody').append(row);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading purchase data:', error, status);
                    var errorMsg = $('<tr><td colspan="12" style="text-align:center; color:red;">入庫処理データの読み込みに失敗しました。</td></tr>');
                    $('#purchase-table tbody').append(errorMsg);
                }
            });
        }

        function handleReceive(orderNumber) { // 引数名を orderId から orderNumber に変更
            // orderNumber が null, undefined, または空文字列でないことを確認
            if (!orderNumber) { // orderNumber が falsy (空文字列, null, undefinedなど) の場合
                alert('処理対象の発注番号が不明なため、入庫処理を実行できません。'); // メッセージを「発注番号」に修正
                console.error('handleReceive error: orderNumber is missing or invalid. Provided orderNumber:', orderNumber);
                return;
            }

            var receivedQtyStr = prompt("入庫する数量を入力してください:", "");
            if (receivedQtyStr === null) { // キャンセルされた場合
                return;
            }

            var receivedQty = parseInt(receivedQtyStr);
            if (isNaN(receivedQty) || receivedQty <= 0) {
                alert("有効な数量を入力してください。");
                return;
            }

            $.ajax({
                url: '/inventory/purchase/scan/', // 修正: 正しいAPIエンドポイント
                type: 'POST',
                dataType: 'json',
                data: {
                    order_number: orderNumber, // purchase_order_id の代わりに order_number を使用
                    received_quantity: receivedQty, // 追加: 入庫数量
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function(data) {
                    // HTTP 200 OK は成功とみなす
                    alert('入庫処理が完了しました。発注番号: ' + data.order_number + ', 新しい入庫済数量: ' + data.received_quantity);
                    loadPurchaseData(); // データを再読み込み
                },
                error: function(xhr, status, error) {
                    console.error('Error handling receive:', status, error, xhr.responseText);
                    var errorMsg = '入庫処理に失敗しました。';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg += '\n理由: ' + xhr.responseJSON.error;
                    }
                    alert(errorMsg);
                }
            });
        }

        // handleScan関数は、現状バーコードを order_number として扱い、
        // received_quantity を要求するバックエンドAPI (/inventory/purchase/scan/) を呼び出します。
        // このため、このままでは「入庫データ読込」ボタン単独での入庫処理は完了しません。
        // 本来は、バーコードで品目を特定し、ユーザーに入庫数量を別途入力させるフローが必要です。
        // ここでは、エラーメッセージの表示を改善するに留めます。
        //
        // もし「入庫データ読込」ボタンが純粋にデータをフィルタリングまたは検索する目的なら、
        // バックエンドにGETリクエストを送る別のAPIエンドポイントを用意するか、
        // クライアントサイドでフィルタリングするロジックに変更する必要があります。

        function handleScan() {
            var barcode = $('#barcode-input').val();
            if (barcode) {
                $.ajax({
                    url: '/inventory/purchase/scan/',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        // バックエンドAPIは order_number または purchase_order_id を期待します。
                        // ここでは barcode が order_number であると仮定して送信してみます。
                        // ただし、これだけでは received_quantity が不足しているため、
                        // バックエンドからはエラーが返されることが想定されます。
                        order_number: barcode,
                        // received_quantity: ??? (この情報がないため、APIはエラーを返す)
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(data) {
                        // このAPIは成功時(200 OK)に更新されたPurchaseOrderオブジェクトを返す
                        // しかし、handleScanの現在の呼び出し方では、received_quantityがないため
                        // 200 OK になることは期待しづらい。
                        alert('スキャン処理が予期せず成功しました。データを確認してください。');
                        loadPurchaseData();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error handling scan:', status, error, xhr.responseText);
                        var errorMsg = 'バーコード/シリアル番号の読み込み処理に失敗しました。';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg += '\n理由: ' + xhr.responseJSON.error;
                        }
                        alert(errorMsg);
                    }
                });
            } else {
                alert('バーコード/シリアル番号を入力してください。');
            }
        }

        loadPurchaseData(); // ページ読み込み時にデータを取得
        $('#scan-button').click(handleScan);
    });
</script>

{% endblock inventory_content %}
