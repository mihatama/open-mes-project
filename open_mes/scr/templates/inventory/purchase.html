{% extends "inventory/base.html" %}
{% load md5url %}
{% block inventory_content %}
{{ auto_refresh|safe }}

<div id="purchase-container">
    {% csrf_token %} {# Add CSRF token for AJAX POST requests #}
    <h2>入庫処理一覧</h2>
    <div id="info-area" style="margin-bottom: 10px;">
        <span id="purchase-count-info"></span>
    </div>
    <div id="scan-area">
        <label for="barcode-input">バーコード/シリアル番号/発注番号:</label>
        <input type="text" id="barcode-input" name="barcode-input">
        <button id="scan-button">検索</button>
    </div>
    <table id="purchase-table" class="inventory-table">
        <thead>
            <tr>
                <th>発注番号</th>
                <th>仕入れ先</th>
                <th>品名</th>
                <th>発注数量</th>
                <th>入庫済数量</th>
                <th>発注日</th>
                <th>到着予定日</th>
                <th>倉庫</th>
                <th>ステータス</th>
                <th>バーコード</th>
                <th>シリアル番号</th>
                <th>処理</th>
            </tr>
        </thead>
        <tbody>
            <!-- ここにAJAXで取得したデータが挿入されます -->
        </tbody>
    </table>
    <div id="pagination-controls" class="pagination">
        <!-- ここにページネーションボタンが挿入されます -->
    </div>
</div>

<style>
    /* Note: Common table styles for .inventory-table are assumed to be moved to a shared CSS file or base.html */
    #scan-area {
        margin-bottom: 20px;
    }
    .receive-button {
        background-color: #4CAF50; /* Green */
        border: none;
        color: white;
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        margin: 2px;
        cursor: pointer;
        border-radius: 5px;
    }
    /* Pagination styles updated based on schedule.html */
    .pagination { margin-top: 20px; text-align: center; }
    .page-btn {
      margin: 0 5px;
      padding: 5px 10px;
      border: 1px solid #ddd;
      background: #f8f8f8;
      cursor: pointer;
    }
    .page-btn.active,
    .page-btn:disabled {
      background: #007bff;
      color: #fff;
      border-color: #007bff;
      cursor: default;
    }
    .page-input {
      width: 50px;
      text-align: center;
      margin: 0 5px;
    }
    .page-go-btn {
      padding: 5px 10px;
      border: 1px solid #ddd;
      background: #e0e0e0;
      cursor: pointer;
    }
    .jump-label {
      margin-left: 15px;
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        let currentPage = 1;
        const pageSize = 100; // 1ページあたりの表示件数
        let currentSearchTerm = ''; // 現在の検索語を保持
        
        // テーブルを描画する関数
        function renderTable(itemsToDisplay) {
            $('#purchase-table tbody').empty(); // テーブルの既存データをクリア
            if (itemsToDisplay && itemsToDisplay.length > 0) {
                $.each(itemsToDisplay, function(index, item) {
                    var row = $('<tr>');
                    row.append($('<td>').text(item.order_number));
                    row.append($('<td>').text(item.supplier));
                    row.append($('<td>').text(item.item));
                    row.append($('<td>').text(item.quantity));
                    row.append($('<td>').text(item.received_quantity));
                    row.append($('<td>').text(item.order_date));
                    row.append($('<td>').text(item.expected_arrival));
                    row.append($('<td>').text(item.warehouse));
                    row.append($('<td>').text(item.status));
                    row.append($('<td>').text(item.barcode || '')); // nullの場合空文字
                    row.append($('<td>').text(item.serial_number || '')); // nullの場合空文字

                    var receiveButton = $('<button>').addClass('receive-button').text('入庫処理').click(function() {
                        handleReceive(item.order_number); // item.id から item.order_number に変更 (元々order_numberだったようです)
                    });
                    var buttonCell = $('<td>').append(receiveButton);
                    row.append(buttonCell);

                    $('#purchase-table tbody').append(row);
                });
            } else {
                var message = '該当するデータが見つかりませんでした。';
                if (currentSearchTerm) {
                    message = '「' + currentSearchTerm + '」に一致するデータは見つかりませんでした。';
                }
                var noDataMsg = $('<tr><td colspan="12" style="text-align:center;">' + message + '</td></tr>');
                $('#purchase-table tbody').append(noDataMsg);
            }
        }

        // サーバーからデータをロードして表示する関数
        function loadPurchaseData(page, searchTerm = '') {
            currentPage = page;
            currentSearchTerm = searchTerm; // 検索語を更新

            let dataUrl = `/inventory/purchase/data/?page=${page}&page_size=${pageSize}`;
            if (searchTerm) {
                dataUrl += `&search=${encodeURIComponent(searchTerm)}`;
            }

            $.ajax({
                url: dataUrl,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    const actualData = data.results || [];
                    const totalCount = data.count || 0;
                    // APIがnum_pagesを提供しない場合に備えてフォールバック計算を追加
                    // ただし、API側でnum_pagesを提供することが推奨されます
                    const totalPages = data.num_pages || (totalCount > 0 ? Math.ceil(totalCount / pageSize) : 0);
                    const startItem = totalCount > 0 ? (currentPage - 1) * pageSize + 1 : 0;
                    const endItem = totalCount > 0 ? Math.min(startItem + pageSize - 1, totalCount) : 0;

                    // Calculate prevPage and nextPage numbers for the new pagination controls
                    const prevPageNum = currentPage > 1 ? currentPage - 1 : null;
                    const nextPageNum = currentPage < totalPages ? currentPage + 1 : null;

                    if (totalCount > 0) {
                        $('#purchase-count-info').text(`全 ${totalCount} 件中 ${startItem} - ${endItem} 件を表示 (ページ ${currentPage} / ${totalPages || 1})`);
                    } else {
                         $('#purchase-count-info').text(searchTerm ? `「${searchTerm}」に一致するデータはありません。` : '該当するデータはありません。');
                    }
                    renderTable(actualData);
                    // Pass totalPages, currentPage, and calculated prev/next page numbers
                    renderPaginationControls(totalPages, currentPage, prevPageNum, nextPageNum);
                },
                error: function(xhr, status, error) {
                    console.error('Error loading purchase data. URL:', dataUrl, 'Status:', status, 'Error:', error, 'Response:', xhr.responseText);
                    $('#purchase-count-info').text('データの読み込みに失敗しました。');
                    var errorDetail = xhr.responseText || 'サーバーからの応答がありません。ネットワーク接続を確認してください。';
                    var userErrorMsg = '入庫処理データの読み込みに失敗しました。';
                    // XSS対策として、エラー詳細をテキストとして挿入
                    var errorRow = $('<tr id="load-error-row"><td colspan="12" style="text-align:center; color:red;">' + userErrorMsg + '<br><small>詳細: ' + $('<div>').text(errorDetail).html() + '</small></td></tr>');
                    $('#purchase-table tbody').empty().append(errorRow);
                    // Call with 0 total pages, current page, and null for prev/next
                    renderPaginationControls(0, currentPage, null, null);
                }
            });
        }

        // Updated renderPaginationControls based on schedule.html
        function renderPaginationControls(totalPages, currentPage, prevPage, nextPage) {
            const $p = $('#pagination-controls').empty();
            if (totalPages <= 1) return;

            // 「前へ」ボタン
            if (prevPage) {
                $('<button class="page-btn prev-btn">&laquo; 前へ</button>')
                    .on('click', () => loadPurchaseData(prevPage, currentSearchTerm))
                    .appendTo($p);
            }

            // 現在ページの前後 ±3 を表示
            const start = Math.max(1, currentPage - 3);
            const end   = Math.min(totalPages, currentPage + 3);
            for (let i = start; i <= end; i++) {
                $('<button class="page-btn">')
                    .text(i)
                    .toggleClass('active', i === currentPage)
                    .prop('disabled', i === currentPage)
                    .on('click', () => loadPurchaseData(i, currentSearchTerm))
                    .appendTo($p);
            }

            // 「次へ」ボタン
            if (nextPage) {
                $('<button class="page-btn next-btn">次へ &raquo;</button>')
                    .on('click', () => loadPurchaseData(nextPage, currentSearchTerm))
                    .appendTo($p);
            }

            // ダイレクトジャンプ用入力＆ボタン
            const $input = $(`<input type="number" min="1" max="${totalPages}" value="${currentPage}" class="page-input">`);
            const $go    = $('<button class="page-go-btn">移動</button>');
            $go.on('click', () => {
                const page = parseInt($input.val(), 10);
                if (page >= 1 && page <= totalPages && page !== currentPage) {
                    loadPurchaseData(page, currentSearchTerm);
                }
            });
            // Enterキーでも移動
            $input.on('keypress', e => {
                if (e.which === 13) $go.click();
            });

            $p.append($('<span class="jump-label">ページ: </span>'), $input, $go);
        }

        function handleReceive(orderNumber) {
            // orderNumber が null, undefined, または空文字列でないことを確認
            if (!orderNumber) { // orderNumber が falsy (空文字列, null, undefinedなど) の場合
                alert('処理対象の発注番号が不明なため、入庫処理を実行できません。'); // メッセージを「発注番号」に修正
                console.error('handleReceive error: orderNumber is missing or invalid. Provided orderNumber:', orderNumber);
                return;
            }

            var receivedQtyStr = prompt("入庫する数量を入力してください:", "");
            if (receivedQtyStr === null) { // キャンセルされた場合
                return;
            }

            var receivedQty = parseInt(receivedQtyStr);
            if (isNaN(receivedQty) || receivedQty <= 0) {
                alert("有効な数量を入力してください。");
                return;
            }

            $.ajax({
                url: '/inventory/purchase/scan/', // 修正: 正しいAPIエンドポイント
                type: 'POST',
                dataType: 'json',
                data: {
                    order_number: orderNumber, // purchase_order_id の代わりに order_number を使用
                    received_quantity: receivedQty, // 追加: 入庫数量
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function(data) {
                    // HTTP 200 OK は成功とみなす
                    alert('入庫処理が完了しました。発注番号: ' + data.order_number + ', 新しい入庫済数量: ' + data.received_quantity);
                    loadPurchaseData(currentPage, currentSearchTerm); // 現在のページと検索条件で再読み込み
                },
                error: function(xhr, status, error) {
                    console.error('Error handling receive:', status, error, xhr.responseText);
                    var errorMsg = '入庫処理に失敗しました。';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg += '\n理由: ' + xhr.responseJSON.error;
                    } else if (xhr.responseJSON && xhr.responseJSON.detail) { // DRFのデフォルトエラーの場合
                        errorMsg += '\n理由: ' + xhr.responseJSON.detail;
                    } else if (xhr.responseText) { // その他のテキストエラー
                        try { // JSON形式のエラーメッセージを試みる
                            const errData = JSON.parse(xhr.responseText);
                            if (errData && errData.error) {
                                errorMsg += '\n理由: ' + errData.error;
                            } else if (errData && errData.detail) {
                                errorMsg += '\n理由: ' + errData.detail;
                            }
                        } catch (e) {
                            // JSONパース失敗時はプレーンテキストとして一部表示 (長すぎる場合は省略)
                            // errorMsg += '\n詳細: ' + xhr.responseText.substring(0, 100);
                        }
                    }
                    alert(errorMsg);
                }
            });
        }

        // 「検索」ボタンがクリックされたときの処理
        function handleScan() {
            const searchTerm = $('#barcode-input').val().trim();
            loadPurchaseData(1, searchTerm); // 検索時は1ページ目から
        }

        loadPurchaseData(currentPage, currentSearchTerm); // 初期ロード

        // スキャンボタンのクリックイベントハンドラを設定
        $('#scan-button').click(handleScan);

        // バーコード/シリアル番号入力フィールドでEnterキーを押したときにも検索を実行
        $('#barcode-input').keypress(function(event) {
            if (event.which == 13) { // 13 is the keycode for Enter
                event.preventDefault(); // Prevent default form submission
                handleScan();
            }
        });
    });
</script>

{% endblock inventory_content %}
