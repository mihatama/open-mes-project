{% extends "base.html" %}
{% load md5url %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>作業進捗 - 生産計画一覧</h2>

    <div id="loading-message" class="alert alert-info" role="alert">データを読み込み中です...</div>
    <div id="error-message" class="alert alert-danger" role="alert" style="display: none;"></div>

    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered work-progress-data-table">
            <thead>
            <tr>
                <th scope="col">計画名</th>
                <th scope="col">製品コード</th>
                <th scope="col" class="text-end">計画数量</th>
                <th scope="col" class="text-center">計画開始日時</th>
                <th scope="col" class="text-center">ステータス</th>
                <th scope="col" class="text-center">アクション</th>
            </tr>
            </thead>
            <tbody id="production-plans-tbody">
                {# Data will be populated by JavaScript #}
            </tbody>
        </table>
    </div>
    <div id="no-data-message" class="alert alert-info" role="alert" style="display: none;">登録されている生産計画はありません。</div>

    <div id="pagination-controls" class="pagination-controls text-center mt-4">
        {# Pagination will be populated by JavaScript #}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tbody = document.getElementById('production-plans-tbody');
    const paginationControls = document.getElementById('pagination-controls');
    const loadingMessage = document.getElementById('loading-message');
    const errorMessage = document.getElementById('error-message');
    const noDataMessage = document.getElementById('no-data-message');
    const initialUrl = '/api/production/plans/?ordering=-planned_start_datetime'; // Default ordering

    async function fetchProductionPlans(url) {
        loadingMessage.style.display = 'block';
        errorMessage.style.display = 'none';
        noDataMessage.style.display = 'none';
        tbody.innerHTML = ''; // Clear existing rows
        paginationControls.innerHTML = ''; // Clear existing pagination

        try {
            const response = await fetch(url);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            loadingMessage.style.display = 'none';

            if (data.results && data.results.length > 0) {
                data.results.forEach(plan => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = plan.plan_name;
                    row.insertCell().textContent = plan.product_code;

                    const quantityCell = row.insertCell();
                    quantityCell.textContent = plan.planned_quantity;
                    quantityCell.classList.add('text-end');

                    // Format datetime, API returns ISO string e.g., "2025-05-18T09:37:00Z"
                    const startDate = new Date(plan.planned_start_datetime);
                    const dateCell = row.insertCell();
                    dateCell.textContent = startDate.toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                    dateCell.classList.add('text-center');

                    const statusCell = row.insertCell();
                    statusCell.textContent = plan.status; // Serializer provides get_status_display
                    statusCell.classList.add('text-center');

                    const actionCell = row.insertCell();
                    actionCell.classList.add('text-center');
                    // TODO: Update href to actual progress detail view when available
                    actionCell.innerHTML = `<a href="#" class="btn btn-sm btn-primary" data-plan-id="${plan.id}">進捗確認</a>`;
                });
            } else {
                noDataMessage.style.display = 'block';
            }

            renderPagination(data);

        } catch (error) {
            loadingMessage.style.display = 'none';
            errorMessage.textContent = `データの読み込みに失敗しました: ${error.message}`;
            errorMessage.style.display = 'block';
            console.error('Error fetching production plans:', error);
        }
    }

    function renderPagination(data) {
        if (!data.count || data.count === 0) return;

        let currentPage = 1;
        if (data.next) {
            const nextPageUrl = new URL(data.next, window.location.origin);
            currentPage = parseInt(nextPageUrl.searchParams.get('page')) - 1;
        } else if (data.previous) {
            const prevPageUrl = new URL(data.previous, window.location.origin);
            currentPage = parseInt(prevPageUrl.searchParams.get('page')) + 1;
        } else if (data.results.length > 0) { // Only one page
             // No next or previous, but results exist, so it's page 1
        }

        const totalPages = Math.ceil(data.count / (data.results.length || 1)); // Assuming consistent page size

        let paginationHtml = '';
        paginationHtml += `<button class="btn btn-outline-primary mx-1" ${data.previous ? '' : 'disabled'} onclick="fetchProductionPlans('${data.previous}')">前へ</button>`;
        paginationHtml += `<span class="mx-2 align-middle">ページ ${currentPage} / ${totalPages} (全 ${data.count} 件)</span>`;
        paginationHtml += `<button class="btn btn-outline-primary mx-1" ${data.next ? '' : 'disabled'} onclick="fetchProductionPlans('${data.next}')">次へ</button>`;
        paginationControls.innerHTML = paginationHtml;
    }

    // Initial fetch
    fetchProductionPlans(initialUrl);

    // Make fetchProductionPlans globally accessible if pagination buttons need to call it directly
    window.fetchProductionPlans = fetchProductionPlans;
});
</script>
{% endblock content %}

{% block js_link %}{% endblock js_link %}
