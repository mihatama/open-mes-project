{% extends "base.html" %}
{% load md5url %}

{% block title %}{{ page_title|default:"データ投入" }}{% endblock title %}

{% block content %}
<div class="container mt-4">
    <h2>{{ page_title|default:"データ投入" }}</h2>

    <h3 class="mt-4">マスターデータ登録</h3>
    <p>登録または呼び出したいマスターを選択してください。</p>

    <div class="mb-5">
        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">品番マスター</h5>
                        <p class="card-text small">新しい品番マスターデータを登録します。</p>
                        <button type="button" class="btn btn-primary w-100 mt-auto mb-2" data-bs-toggle="modal" data-bs-target="#dataImportModal" data-master-type="item" data-master-name="品番マスター">
                            品番マスター登録
                        </button>
                        <a href="#" class="btn btn-outline-secondary w-100"
                           data-bs-toggle="modal" data-bs-target="#dataListModal"
                           data-list-url="{% url 'master:item_list_ajax' %}"
                           data-master-name="品番マスター"
                           data-master-type="item">品番マスター呼び出し</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">サプライヤーマスター</h5>
                        <p class="card-text small">新しいサプライヤーマスターデータを登録します。</p>
                        <button type="button" class="btn btn-primary w-100 mt-auto mb-2" data-bs-toggle="modal" data-bs-target="#dataImportModal" data-master-type="supplier" data-master-name="サプライヤーマスター">
                            サプライヤーマスター登録
                        </button>
                        <a href="#" class="btn btn-outline-secondary w-100"
                           data-bs-toggle="modal" data-bs-target="#dataListModal"
                           data-list-url="{% url 'master:supplier_list_ajax' %}"
                           data-master-name="サプライヤーマスター"
                           data-master-type="supplier">サプライヤーマスター呼び出し</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">倉庫マスター</h5>
                        <p class="card-text small">新しい倉庫マスターデータを登録します。</p>
                        <button type="button" class="btn btn-primary w-100 mt-auto mb-2" data-bs-toggle="modal" data-bs-target="#dataImportModal" data-master-type="warehouse" data-master-name="倉庫マスター">
                            倉庫マスター登録
                        </button>
                        <a href="#" class="btn btn-outline-secondary w-100"
                           data-bs-toggle="modal" data-bs-target="#dataListModal"
                           data-list-url="{% url 'master:warehouse_list_ajax' %}"
                           data-master-name="倉庫マスター"
                           data-master-type="warehouse">倉庫マスター呼び出し</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h3 class="mt-5">業務データ登録</h3>
    <p>登録したい業務データを選択してください。</p>
    <div class="row">
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">入庫予定登録</h5>
                    <p class="card-text small">新しい入庫予定データを登録します。</p>
                    <button type="button" class="btn btn-info w-100 mt-auto mb-2" data-bs-toggle="modal" data-bs-target="#dataImportModal" data-master-type="inventory-purchase-entry" data-master-name="入庫予定">
                        入庫予定登録
                    </button>
                    <a href="#" class="btn btn-outline-secondary w-100"
                       data-bs-toggle="modal" data-bs-target="#dataListModal"
                       data-list-url="{% url 'inventory_api:purchase_order_list_ajax' %}"
                       data-master-name="入庫予定"
                       data-master-type="inventory-purchase-entry">入庫予定呼び出し</a>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">生産計画登録</h5>
                    <p class="card-text small">新しい生産計画データを登録します。</p>
                    <button type="button" class="btn btn-info w-100 mt-auto mb-2" data-bs-toggle="modal" data-bs-target="#dataImportModal" data-master-type="production-plan-entry" data-master-name="生産計画">
                        生産計画登録
                    </button>
                    <a href="#" class="btn btn-outline-secondary w-100"
                       data-bs-toggle="modal" data-bs-target="#dataListModal"
                       data-list-url="{% url 'production:production_plan_list_ajax' %}"
                       data-master-name="生産計画"
                       data-master-type="production-plan-entry">生産計画呼び出し</a>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">使用部品登録</h5>
                    <p class="card-text small">新しい使用部品データを登録します。</p>
                    <button type="button" class="btn btn-info w-100 mt-auto mb-2" data-bs-toggle="modal" data-bs-target="#dataImportModal" data-master-type="parts-used-entry" data-master-name="使用部品">
                        使用部品登録
                    </button>
                    <a href="#" class="btn btn-outline-secondary w-100"
                       data-bs-toggle="modal" data-bs-target="#dataListModal"
                       data-list-url="{% url 'production:parts_used_list_ajax' %}"
                       data-master-name="使用部品"
                       data-master-type="parts-used-entry">使用部品呼び出し</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 非表示のフォームテンプレートエリア -->
    <div id="form-templates" style="display: none;">
        <div id="item-form-template">
            <form method="post" id="itemMasterForm" action="{% url 'master:item_create_ajax' %}">
                {% csrf_token %}
                <input type="hidden" name="id" id="item_id">
                {{ item_form.as_p }}
            </form>
        </div>
        <div id="supplier-form-template">
            <form method="post" id="supplierMasterForm" action="{% url 'master:supplier_create_ajax' %}">
                {% csrf_token %}
                <input type="hidden" name="id" id="supplier_id">
                {{ supplier_form.as_p }}
            </form>
        </div>
        <div id="warehouse-form-template">
            <form method="post" id="warehouseMasterForm" action="{% url 'master:warehouse_create_ajax' %}">
                {% csrf_token %}
                <input type="hidden" name="id" id="warehouse_id">
                {{ warehouse_form.as_p }}
            </form>
        </div>
        <div id="inventory-purchase-entry-form-template">
            <form method="post" id="inventoryPurchaseEntryForm" action="{% url 'inventory_api:purchase_order_create_ajax' %}">
                {% csrf_token %}
                <input type="hidden" name="id" id="inventory_purchase_entry_id">
                {{ inventory_purchase_entry_form.as_p }}
            </form>
        </div>
        <div id="production-plan-entry-form-template">
            <form method="post" id="productionPlanEntryForm" action="{% url 'production:production_plan_create_ajax' %}">
                {% csrf_token %}
                <input type="hidden" name="id" id="production_plan_entry_id">
                {{ production_plan_data_entry_form.as_p }}
            </form>
        </div>
        <div id="parts-used-entry-form-template">
            <form method="post" id="partsUsedEntryForm" action="{% url 'production:parts_used_create_ajax' %}">
                {% csrf_token %}
                <input type="hidden" name="id" id="parts_used_entry_id">
                {{ parts_used_data_entry_form.as_p }}
            </form>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="dataImportModal" tabindex="-1" aria-labelledby="dataImportModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dataImportModalLabel">マスターデータ登録</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>選択されたマスター: <strong id="selectedMasterTypeDisplay"></strong></p>
                    <div id="masterFormContainer">
                        
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    <button type="button" class="btn btn-success" id="saveMasterDataButton">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- List Modal -->
    <div class="modal fade" id="dataListModal" tabindex="-1" aria-labelledby="dataListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dataListModalLabel">登録済み一覧</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="dataListModalBody">
                    <p class="text-center">データを読み込んでいます...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">削除確認</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>本当に「<strong id="deleteMasterNamePlaceholder"></strong>」を削除しますか？この操作は元に戻せません。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-danger" id="executeDeleteButton">削除実行</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block js_link %}
{# <script src="{% md5url 'js/master_data_import.js' %}"></script> #}
{# <link rel="stylesheet" href="{% md5url 'css/master_data_import.css' %}" /> #}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const dataImportModal = document.getElementById('dataImportModal');
    const masterFormContainer = document.getElementById('masterFormContainer');

    // Registration Modal Logic
    if (dataImportModal && masterFormContainer) {
        dataImportModal.addEventListener('show.bs.modal', function (event) {
            // data-bs-backdrop="static" と data-bs-keyboard="false" を設定
            dataImportModal.setAttribute('data-bs-backdrop', 'static');
            dataImportModal.setAttribute('data-bs-keyboard', 'false');
            const button = event.relatedTarget; // モーダルをトリガーしたボタン

            if (button) { // `button` is event.relatedTarget. Only proceed if modal was triggered by a button.
                const masterName = button.getAttribute('data-master-name');
                const masterType = button.getAttribute('data-master-type');

                // This block is for NEW registrations.
                // For NEW, ID fields should be clear. data-record-id won't be on the "New" button.
                clearHiddenIdFields(); 

                const modalTitle = dataImportModal.querySelector('.modal-title');
                const selectedMasterTypeDisplay = dataImportModal.querySelector('#selectedMasterTypeDisplay');

                modalTitle.textContent = masterName + ' 登録'; // Set title for new registration
                selectedMasterTypeDisplay.textContent = masterName;
                masterFormContainer.innerHTML = ''; // Clear previous form content

                let formTemplateHtml = '';
                // let formIdPrefix = ''; // formIdPrefix was not used, can be removed if not needed later
                if (masterType === 'item') {
                    const itemFormTemplate = document.getElementById('item-form-template');
                    if (itemFormTemplate) formTemplateHtml = itemFormTemplate.innerHTML;
                    else formTemplateHtml = '<p class="text-danger">品番マスターのフォームテンプレートが見つかりません。</p>';
                    // formIdPrefix = 'item';
                } else if (masterType === 'supplier') {
                    const supplierFormTemplate = document.getElementById('supplier-form-template');
                    if (supplierFormTemplate) formTemplateHtml = supplierFormTemplate.innerHTML;
                    else formTemplateHtml = '<p class="text-danger">サプライヤーマスターのフォームテンプレートが見つかりません。</p>';
                    // formIdPrefix = 'supplier';
                } else if (masterType === 'warehouse') {
                    const warehouseFormTemplate = document.getElementById('warehouse-form-template');
                    if (warehouseFormTemplate) formTemplateHtml = warehouseFormTemplate.innerHTML;
                    else formTemplateHtml = '<p class="text-danger">倉庫マスターのフォームテンプレートが見つかりません。</p>';
                    // formIdPrefix = 'warehouse';
                } else if (masterType === 'inventory-purchase-entry') { {# Corrected masterType #}
                    const purchaseEntryFormTemplate = document.getElementById('inventory-purchase-entry-form-template');
                    if (purchaseEntryFormTemplate) formTemplateHtml = purchaseEntryFormTemplate.innerHTML;
                    else formTemplateHtml = '<p class="text-danger">入庫予定登録のフォームテンプレートが見つかりません。</p>';
                } else if (masterType === 'production-plan-entry') { {# Corrected masterType #}
                    const planFormTemplate = document.getElementById('production-plan-entry-form-template');
                    if (planFormTemplate) formTemplateHtml = planFormTemplate.innerHTML;
                    else formTemplateHtml = '<p class="text-danger">生産計画登録のフォームテンプレートが見つかりません。</p>';
                } else if (masterType === 'parts-used-entry') { {# Corrected masterType #}
                    const partsUsedFormTemplate = document.getElementById('parts-used-entry-form-template');
                    if (partsUsedFormTemplate) formTemplateHtml = partsUsedFormTemplate.innerHTML;
                    else formTemplateHtml = '<p class="text-danger">使用部品登録のフォームテンプレートが見つかりません。</p>';
                }
                masterFormContainer.innerHTML = formTemplateHtml;

                // Set form action for new registration and ensure hidden ID is clear
                const newForm = masterFormContainer.querySelector('form');
                if (newForm) {
                    newForm.setAttribute('action', getFormActionUrl(masterType, null));
                    const idFieldInNewForm = newForm.querySelector('input[type="hidden"][name="id"]');
                    if (idFieldInNewForm) {
                        idFieldInNewForm.value = '';
                    }
                }
            }
            // If 'button' (event.relatedTarget) is null, the modal was shown programmatically (e.g., for editing).
            // In that case, the calling code (edit button handler) is responsible for setting up the modal's
            // title, form content, populating data, and setting the action URL.
        });

        dataImportModal.addEventListener('shown.bs.modal', function () {
            // モーダルが完全に表示された後、フォーム内の最初のフォーカス可能な要素にフォーカスを当てる
            // (data-bs-dismiss属性を持つボタンは除外しても良いが、現状のフォーム内には無いためシンプルに)
            const firstFocusableElement = masterFormContainer.querySelector('input, select, textarea, button');
            if (firstFocusableElement) {
                firstFocusableElement.focus();
            }
        });

        dataImportModal.addEventListener('hide.bs.modal', function () {
            // モーダルが閉じるときに属性を元に戻すか削除
            dataImportModal.removeAttribute('data-bs-backdrop');
            dataImportModal.removeAttribute('data-bs-keyboard');
            // フォーム内のIDフィールドもクリア
            clearHiddenIdFieldsInModal();
        });
    }

    function clearHiddenIdFieldsInModal() {
        const idFields = masterFormContainer.querySelectorAll('input[type="hidden"][name="id"]');
        idFields.forEach(field => field.value = '');
    }
    function clearHiddenIdFields() {
        document.getElementById('item_id')?.setAttribute('value', '');
        document.getElementById('supplier_id')?.setAttribute('value', '');
        document.getElementById('warehouse_id')?.setAttribute('value', '');
        document.getElementById('inventory_purchase_entry_id')?.setAttribute('value', '');
        document.getElementById('production_plan_entry_id')?.setAttribute('value', '');
        document.getElementById('parts_used_entry_id')?.setAttribute('value', '');
    }

    const saveMasterDataButton = document.getElementById('saveMasterDataButton');
    if (saveMasterDataButton) {
        saveMasterDataButton.addEventListener('click', function() {
            const currentForm = masterFormContainer.querySelector('form');
            if (!currentForm) {
                console.error('No form found in modal.');
                alert('エラー: フォームが見つかりません。');
                return;
            }

            const formData = new FormData(currentForm);
            const url = currentForm.getAttribute('action');
            const method = currentForm.getAttribute('method');

            fetch(url, {
                method: method.toUpperCase(),
                body: formData,
                // CSRFトークンはFormDataに含まれているため、通常はヘッダーで明示的に送信する必要はありません。
                // DjangoはPOSTデータ内の`csrfmiddlewaretoken`フィールドを自動的にチェックします。
            })
            .then(response => {
                // HTTPステータスコードがエラー(4xx, 5xx)の場合でもJSON本文を解析試行
                return response.json().then(data => ({ status: response.status, body: data }));
            })
            .then(res => {
                // res.status は HTTPステータスコード
                // res.body は JSONレスポンスボディ
                if (res.status === 200 && res.body.status === 'success') {
                    alert(res.body.message || '保存しました。');
                    // モーダルを閉じる前に、現在フォーカスされている要素（通常は保存ボタン）からフォーカスを外す
                    // これにより、aria-hiddenが設定される要素の子孫がフォーカスを保持する問題を回避する
                    if (document.activeElement instanceof HTMLElement) {
                        document.activeElement.blur();
                    }
                    bootstrap.Modal.getInstance(dataImportModal).hide();

                    // モーダルが閉じた後、元のテンプレート内のフォームをリセット
                    const formId = currentForm.id; // 例: "itemMasterForm"
                    let originalFormToReset;
                    if (formId === 'itemMasterForm') {
                        originalFormToReset = document.getElementById('item-form-template')?.querySelector('form');
                    } else if (formId === 'supplierMasterForm') {
                        originalFormToReset = document.getElementById('supplier-form-template')?.querySelector('form');
                    } else if (formId === 'warehouseMasterForm') {
                        originalFormToReset = document.getElementById('warehouse-form-template')?.querySelector('form');
                    } else if (formId === 'inventoryPurchaseEntryForm') {
                        originalFormToReset = document.getElementById('inventory-purchase-entry-form-template')?.querySelector('form');
                    } else if (formId === 'productionPlanEntryForm') {
                        originalFormToReset = document.getElementById('production-plan-entry-form-template')?.querySelector('form');
                    } else if (formId === 'partsUsedEntryForm') {
                        originalFormToReset = document.getElementById('parts-used-entry-form-template')?.querySelector('form');
                    }  else {
                        console.log('Form reset logic for ' + formId + ' not yet implemented.');
                    }
                    if (originalFormToReset) {
                        originalFormToReset.reset();
                        clearHiddenIdFields(); // テンプレート内のIDもクリア
                    }

                } else if (res.body.status === 'error' && res.body.errors) {
                    let errorMessages = '以下のエラーが発生しました:\n';
                    for (const field in res.body.errors) {
                        errorMessages += `・${field}: ${res.body.errors[field].join(', ')}\n`;
                    }
                    alert(errorMessages);
                } else {
                    alert(res.body.message || 'エラーが発生しました。サーバーからの応答を確認してください。');
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                alert('保存中に通信エラーまたは予期しないエラーが発生しました。コンソールを確認してください。');
            });
        });
    }

    // List Modal Logic
    const dataListModal = document.getElementById('dataListModal');
    const dataListModalBody = document.getElementById('dataListModalBody');
    const dataListModalLabel = document.getElementById('dataListModalLabel');

    if (dataListModal && dataListModalBody && dataListModalLabel) {
        dataListModal.addEventListener('show.bs.modal', async function (event) {
            const button = event.relatedTarget;
            const listUrl = button.getAttribute('data-list-url');
            const masterName = button.getAttribute('data-master-name');
            const masterType = button.getAttribute('data-master-type');

            dataListModalLabel.textContent = masterName + ' 一覧';
            dataListModalBody.innerHTML = '<p class="text-center">データを読み込んでいます...</p>';

            try {
                const response = await fetch(listUrl);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({})); // Try to parse error, default to empty obj
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || response.statusText}`);
                }
                const result = await response.json();
                const data = result.data;

                if (data && data.length > 0) {
                    let tableHtml = '<div class="table-responsive"><table class="table table-striped table-hover table-sm">';
                    tableHtml += '<thead class="table-light"><tr>';
                    let headers = [];
                    let rowKeys = []; // 表示するデータのキー
                    let idKey = 'id'; // レコードの主キー

                    if (masterType === 'item') {
                        headers = ['コード', '品番名', '品目タイプ', '単位', '説明', '操作'];
                        rowKeys = ['code', 'name', 'item_type', 'unit', 'description'];
                    } else if (masterType === 'supplier') {
                        headers = ['サプライヤー名', '担当者名', '電話番号', 'メールアドレス', '住所', '操作'];
                        rowKeys = ['name', 'contact_person', 'phone', 'email', 'address'];
                    } else if (masterType === 'warehouse') {
                        headers = ['倉庫番号', '倉庫名', '所在地', '操作']; // 3 data columns + 操作
                        rowKeys = ['warehouse_number', 'name', 'location'];
                    } else if (masterType === 'inventory-purchase-entry') {
                        // 8 data columns + 操作 (Corrected rowKeys below)
                        headers = ['発注番号', '便番号', '仕入れ先', '品番', '品名', '数量', '入荷予定日', 'ステータス', '操作'];
                        // Fix: Added 'delivery_number' to match '便番号' header and reordered keys
                        rowKeys = ['order_number', 'delivery_number', 'supplier', 'part_number', 'product_name', 'quantity', 'expected_arrival', 'status'];
                    } else if (masterType === 'production-plan-entry') { {# Corrected masterType #}
                        headers = ['計画名', '製品コード', '品名', '計画数量', '計画開始日時', 'ステータス', '操作']; // 6 data columns + 操作
                        // Note: 'product_name' is used here, ensure it's available in the API response for production plans
                        rowKeys = ['plan_name', 'product_code', 'product_name', 'planned_quantity', 'planned_start_datetime', 'status'];
                    } else if (masterType === 'parts-used-entry') { {# Corrected masterType #}
                        headers = ['生産計画', '部品コード', '倉庫', '使用数量', '使用日時', '操作'];
                        rowKeys = ['production_plan', 'part_code', 'warehouse', 'quantity_used', 'used_datetime'];
                        // Warehouseの主キーは'id' (UUID)
                    }

                    headers.forEach(header => tableHtml += `<th>${header}</th>`);
                    tableHtml += '</tr></thead><tbody>';

                    data.forEach(row => {
                        tableHtml += '<tr>';
                        rowKeys.forEach(key => {
                            // HTMLエスケープを簡易的に行う（より堅牢なライブラリ使用を推奨する場合もある）
                            const cellData = row[key] !== null && row[key] !== undefined ? String(row[key]) : '';
                            const escapedCellData = cellData.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
                            tableHtml += `<td>${escapedCellData}</td>`;
                        });
                        // 修正ボタンを追加
                        const recordId = row[idKey];
                        tableHtml += `<td>
                                        <button type="button" class="btn btn-sm btn-warning edit-master-btn me-1" 
                                                data-record-id="${recordId}" data-master-type="${masterType}"
                                                data-master-name="${masterName}">修正</button>
                                        <button type="button" class="btn btn-sm btn-danger delete-master-btn"
                                                data-record-id="${recordId}" data-master-type="${masterType}"
                                                data-master-name="${masterName}">削除</button>
                                      </td>`;
                        tableHtml += '</tr>';
                    });

                    tableHtml += '</tbody></table></div>';
                    dataListModalBody.innerHTML = tableHtml;
                } else {
                    dataListModalBody.innerHTML = '<p class="text-center">登録されているデータはありません。</p>';
                }
            } catch (error) {
                console.error('Error fetching list data:', error);
                dataListModalBody.innerHTML = `<p class="text-center text-danger">データの読み込みに失敗しました。<br>${error.message}</p>`;
            }
        });

        // オプション: モーダルが閉じられたときに内容をクリアする
        dataListModal.addEventListener('hidden.bs.modal', function () {
            dataListModalBody.innerHTML = '<p class="text-center">データを読み込んでいます...</p>'; // 次回表示時のため
            // イベントリスナーのクリーンアップ（重複登録を防ぐため）
            const oldEditButtons = dataListModalBody.querySelectorAll('.edit-master-btn');
            oldEditButtons.forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
            });
        });

        // 一覧モーダル内の修正ボタンのイベントリスナー (イベント委譲を使用)
        dataListModalBody.addEventListener('click', async function(event) { // Combined event listener
            const targetButton = event.target;
            if (targetButton.classList.contains('edit-master-btn')) {
                const button = event.target;
                const recordId = button.getAttribute('data-record-id');
                const masterType = button.getAttribute('data-master-type');
                const masterName = button.getAttribute('data-master-name');
                
                const detailUrl = getDetailUrl(masterType, recordId);
                if (!detailUrl) {
                    alert('エラー: 詳細情報のURLが取得できません。');
                    return;
                }

                try {
                    const response = await fetch(detailUrl);
                    if (!response.ok) {
                        throw new Error(`Error fetching record details: ${response.statusText}`);
                    }
                    const result = await response.json();
                    if (result.status === 'success' && result.data) {
                        // 1. 登録用モーダルを開く準備
                        const registrationModal = bootstrap.Modal.getInstance(dataImportModal) || new bootstrap.Modal(dataImportModal);
                        
                        // 登録用モーダルのタイトルなどを設定
                        dataImportModal.querySelector('.modal-title').textContent = masterName + ' 修正';
                        dataImportModal.querySelector('#selectedMasterTypeDisplay').textContent = masterName;
                        
                        // フォームテンプレートをロード
                        const formTemplate = document.getElementById(`${masterType}-form-template`);
                        if (formTemplate) {
                            masterFormContainer.innerHTML = formTemplate.innerHTML;
                            const form = masterFormContainer.querySelector('form');
                            if (form) {
                                // フォームに取得したデータを設定
                                for (const key in result.data) {
                                    const field = form.elements[key];
                                    if (field) {
                                        if (field.type === 'checkbox' || field.type === 'radio') {
                                            // TODO: 必要に応じてラジオボタンやチェックボックスの処理を追加
                                        } else {
                                            field.value = result.data[key] === null ? '' : result.data[key];
                                        }
                                    }
                                }
                                // IDフィールドにも値を設定
                                const idField = form.elements['id'];
                                if (idField) idField.value = result.data.id;

                                // action属性は既存の作成用URLのままでOK (ビュー側でIDの有無で判定)
                                form.setAttribute('action', getFormActionUrl(masterType, result.data.id));
                            }
                        } else {
                             masterFormContainer.innerHTML = `<p class="text-danger">${masterName}のフォームテンプレートが見つかりません。</p>`;
                        }

                        // 2. 一覧モーダルを閉じる
                        const listModalInstance = bootstrap.Modal.getInstance(dataListModal);
                        if (listModalInstance) listModalInstance.hide();

                        // 閉じられるモーダル内の要素からフォーカスを外す
                        // これにより、aria-hidden警告を回避できる可能性があります。
                        if (document.activeElement instanceof HTMLElement) {
                            document.activeElement.blur();
                        }
                        
                        // 3. 登録用モーダルを開く
                        // hideイベントが完了してからshowを呼ぶために少し遅延させる
                        setTimeout(() => {
                             registrationModal.show();
                        }, 150); // Bootstrapのモーダル遷移時間程度

                    } else {
                        alert('エラー: ' + (result.message || 'レコード詳細の取得に失敗しました。'));
                    }
                } catch (error) {
                    console.error('Error handling edit button click:', error);
                    alert('修正処理中にエラーが発生しました: ' + error.message);
                }
            } else if (targetButton.classList.contains('delete-master-btn')) {
                const button = targetButton;
                const recordId = button.getAttribute('data-record-id');
                const masterType = button.getAttribute('data-master-type');
                const masterName = button.getAttribute('data-master-name'); // For confirmation message

                const deleteConfirmModalInstance = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                document.getElementById('deleteMasterNamePlaceholder').textContent = masterName + " (ID: " + recordId + ")";
                
                const executeDeleteButton = document.getElementById('executeDeleteButton');
                // Store data on the button for the execution step
                executeDeleteButton.dataset.recordId = recordId;
                executeDeleteButton.dataset.masterType = masterType;

                deleteConfirmModalInstance.show();
            }
        });

        const executeDeleteButton = document.getElementById('executeDeleteButton');
        if (executeDeleteButton) {
            executeDeleteButton.addEventListener('click', async function() {
                const recordId = this.dataset.recordId;
                const masterType = this.dataset.masterType;
                const deleteUrl = getDeleteUrl(masterType, recordId);

                if (!deleteUrl) {
                    alert('エラー: 削除用URLが取得できません。');
                    return;
                }

                try {
                    const response = await fetch(deleteUrl, {
                        method: 'POST', // Using POST for CSRF handling simplicity
                        headers: {
                            'X-CSRFToken': getCsrfToken(), // Helper function to get CSRF token
                            'Content-Type': 'application/json' // Or 'application/x-www-form-urlencoded' if not sending JSON body
                        },
                        // body: JSON.stringify({ id: recordId }) // Optional: send ID in body
                    });
                    const result = await response.json();

                    if (response.ok && result.status === 'success') {
                        alert(result.message || '削除しました。');
                        bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
                        
                        // Remove the row from the list modal table
                        const rowToRemove = dataListModalBody.querySelector(`button.delete-master-btn[data-record-id="${recordId}"]`)?.closest('tr');
                        if (rowToRemove) rowToRemove.remove();
                        // Optionally, check if table is empty and show "no data" message
                    } else {
                        alert('エラー: ' + (result.message || '削除に失敗しました。'));
                    }
                } catch (error) {
                    console.error('Error executing delete:', error);
                    alert('削除処理中にエラーが発生しました: ' + error.message);
                }
            });
        }
    }
    function getDetailUrl(masterType, recordId) {
        if (masterType === 'item') return `/master/item/${recordId}/detail/ajax/`;
        if (masterType === 'supplier') return `/master/supplier/${recordId}/detail/ajax/`; // Supplier uses int PK
        if (masterType === 'warehouse') return `/master/warehouse/${recordId}/detail/ajax/`; // Warehouse uses UUID
        if (masterType === 'inventory-purchase-entry') return `/api/inventory/purchase-order/${recordId}/detail/ajax/`;
        if (masterType === 'production-plan-entry') return `/production/ajax/plan/${recordId}/detail/`;
        if (masterType === 'parts-used-entry') return `/production/ajax/parts-used/${recordId}/detail/`; {# Corrected masterType #}
        return null;
    }
    function getFormActionUrl(masterType, recordId) { // recordIdは更新時はセット、新規はnull
        // 更新時も新規作成と同じエンドポイントを使用し、ビュー側でIDの有無で処理を分ける
        if (masterType === 'item') return "{% url 'master:item_create_ajax' %}"; // Item uses int PK
        if (masterType === 'supplier') return "{% url 'master:supplier_create_ajax' %}";
        if (masterType === 'warehouse') return "{% url 'master:warehouse_create_ajax' %}"; // Warehouse uses UUID
        // 他の業務データフォームも同様に
        if (masterType === 'inventory-purchase-entry') return "{% url 'inventory_api:purchase_order_create_ajax' %}";
        if (masterType === 'production-plan-entry') return "{% url 'production:production_plan_create_ajax' %}";
        if (masterType === 'parts-used-entry') return "{% url 'production:parts_used_create_ajax' %}";
        return '#'; // Fallback
    }
    function getDeleteUrl(masterType, recordId) {
        if (masterType === 'item') return `/master/item/${recordId}/delete/ajax/`;
        if (masterType === 'supplier') return `/master/supplier/${recordId}/delete/ajax/`; // Supplier uses int PK
        // Fix: Corrected delete URLs
        if (masterType === 'warehouse') return `/master/warehouse/${recordId}/delete/ajax/`; // Assuming this URL exists for UUID PK
        if (masterType === 'inventory-purchase-entry') return `/api/inventory/purchase-order/${recordId}/delete/ajax/`; // Assuming this URL exists
        if (masterType === 'production-plan-entry') return `/production/ajax/plan/${recordId}/delete/`; {# Corrected masterType #}
        if (masterType === 'parts_used_entry') return `/production/ajax/parts-used/${recordId}/delete/`;
        return null;
    }
    function getCsrfToken() {
        return document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';
    }
});
</script>
{% endblock js_link %}